<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GamEng!</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
       /* General Styles */
body {
    font-family: 'Poppins', sans-serif;
    background: linear-gradient(135deg, #a476ed, #c469e9, #fa6c6c);
    color: #333;
    min-height: 100vh;
}

/* Neumorphic Styles */
.neumorphic {
    background: rgba(255, 255, 255, 0.8);
    box-shadow: 20px 20px 60px rgba(0, 0, 0, 0.1), -20px -20px 60px rgba(255, 255, 255, 0.5);
    border-radius: 30px;
    transition: all 0.3s ease;
}

.neumorphic:hover {
    box-shadow: 10px 10px 30px rgba(0, 0, 0, 0.15), -10px -10px 30px rgba(255, 255, 255, 0.6);
}

.neumorphic-inset {
    background: rgba(255, 255, 255, 0.8);
    box-shadow: inset 8px 8px 16px rgba(0, 0, 0, 0.1), inset -8px -8px 16px rgba(255, 255, 255, 0.7);
    border-radius: 15px;
    border: none;
    outline: none;
    transition: all 0.3s ease;
}

.neumorphic-inset:focus {
    box-shadow: inset 4px 4px 8px rgba(0, 0, 0, 0.1), inset -4px -4px 8px rgba(255, 255, 255, 0.7);
}

/* Bubbly Button */
.neumorphic-button, button {
    background: linear-gradient(135deg, #cad145, #3aa14f);
    color: white;
    border: none;
    border-radius: 50px;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    position: relative;
    overflow: hidden;
}

.neumorphic-button:before, button:before {
    content: "";
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(120deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    transition: all 0.4s ease;
}

.neumorphic-button:hover:before, button:hover:before {
    left: 100%;
}

.neumorphic-button:hover, button:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
}

.neumorphic-button:active, button:active {
    transform: translateY(1px);
    box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
}

/* Progress Bar */
.progress-bar {
    background: rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    overflow: hidden;
    position: relative;
}

.progress {
    background: linear-gradient(90deg, #4CAF50, #8BC34A);
    box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    border-radius: 20px;
    transition: width 0.5s ease-in-out;
}

/* Sidebar */
#sidebar {
    background: rgba(255, 255, 255, 0.807);
    backdrop-filter: blur(10px);
    border-right: 1px solid rgba(255, 255, 255, 0.2);
}

/* Main Content */
#main-content {
    background: rgba(255, 255, 255, 0.05);
    backdrop-filter: blur(5px);
}

/* Auth Container */
#auth-container {
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(10px);
}

/* Responsive Design */
@media (max-width: 768px) {
    #sidebar {
        width: 100%;
        height: auto;
    }

    #main-content {
        margin-left: 0;
    }

    .grid-cols-2 {
        grid-template-columns: 1fr;
    }
    
    .neumorphic, .neumorphic-inset {
        padding: 15px;
        margin-bottom: 15px;
    }
    
    button, .neumorphic-button {
        width: 100%;
        margin-bottom: 10px;
    }
}

/* Animations */
@keyframes float {
    0% { transform: translateY(0px); }
    50% { transform: translateY(-10px); }
    100% { transform: translateY(0px); }
}

.float {
    animation: float 3s ease-in-out infinite;
}

/* Custom Scrollbar */
::-webkit-scrollbar {
    width: 10px;
}

::-webkit-scrollbar-track {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, #6e48aa, #9d50bb);
    border-radius: 10px;
}

::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, #5e3d91, #8a45a3);
}

/* Additional styles for specific elements */
#app-title {
    color: #6e48aa;
    text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
}

.badge-buttons button {
    font-size: 14px;
    padding: 8px 16px;
}


#avatar {
    border: 4px solid white;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
}

.message-container {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 20px;
    padding: 15px;
    margin-bottom: 15px;
    box-shadow: 5px 5px 15px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
}

.message-container:hover {
    transform: translateY(-3px);
    box-shadow: 8px 8px 20px rgba(0, 0, 0, 0.15);
}

#lessons-list .neumorphic, #lessons-management-list .neumorphic {
    height: 100%;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
}

#lessons-list img, #lessons-management-list img {
    border-radius: 15px;
    margin-bottom: 10px;
}

/* Form inputs */
input[type="text"], input[type="email"], input[type="password"], select, textarea {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border-radius: 15px;
    border: none;
    background: rgba(255, 255, 255, 0.8);
    box-shadow: inset 5px 5px 10px rgba(0, 0, 0, 0.1), inset -5px -5px 10px rgba(255, 255, 255, 0.5);
    font-family: 'Poppins', sans-serif;
}

input[type="text"]:focus, input[type="email"]:focus, input[type="password"]:focus, select:focus, textarea:focus {
    outline: none;
    box-shadow: inset 3px 3px 6px rgba(0, 0, 0, 0.1), inset -3px -3px 6px rgba(255, 255, 255, 0.5);
}

/* Specific color adjustments */
.text-indigo-600 {
    color: #6e48aa;
}

.bg-green-500 {
    background: linear-gradient(135deg, #4CAF50, #8BC34A);
}

.bg-red-500 {
    background: linear-gradient(135deg, #f44336, #ff5252);
}

.bg-yellow-400 {
    background: linear-gradient(135deg, #FFC107, #FFEB3B);
}

.bg-blue-400 {
    background: linear-gradient(135deg, #2196F3, #03A9F4);
}

.bg-purple-400 {
    background: linear-gradient(135deg, #9C27B0, #E1BEE7);
}

.bg-pink-400 {
    background: linear-gradient(135deg, #E91E63, #F48FB1);
}

/* Add these styles to your existing CSS */

.lesson-card {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 15px;
    transition: all 0.3s ease;
    overflow: hidden;
}

.lesson-card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
}

.lesson-card-header {
    padding: 1.5rem;
    cursor: pointer;
}

.lesson-card-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease-out;
}

.lesson-card-content.expanded {
    max-height: 1000px; /* Adjust this value based on your content */
    transition: max-height 0.5s ease-in;
}
.lesson-card-body {
    padding: 0 1.5rem 1.5rem;
}

.lesson-card-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-top-left-radius: 15px;
    border-top-right-radius: 15px;
}


/* Ripple effect for buttons */
.ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.7);
    transform: scale(0);
    animation: ripple 0.6s linear;
    pointer-events: none;
}

@keyframes ripple {
    to {
        transform: scale(4);
        opacity: 0;
    }
}
    </style>
    <!-- Include Quill stylesheet -->
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
</head>
<body class="bg-gray-100 font-sans">

<div class="flex h-screen">
    <div id="sidebar" class="neumorphic w-64 p-6 flex flex-col justify-between hidden">
        <div>
            <h2 id="app-title" class="text-2xl font-bold text-center mb-8 text-indigo-600">GamEng!</h2>
            <div id="user-info" class="mb-6">
                <p class="mb-2"><strong class="text-indigo-600">Name:</strong> <span id="user-name" class="text-gray-700"></span></p>
                <p class="mb-2"><strong class="text-indigo-600">Role:</strong> <span id="user-role" class="text-gray-700"></span></p>
                <p><strong class="text-indigo-600">Mode:</strong> <span id="gamification-text" class="text-gray-700"></span></p>
            </div>
            <div id="sidebar-content" class="space-y-4"></div>
        </div>
        <button onclick="logout()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold hover:text-indigo-700">Logout</button>
    </div>

    <div id="main-content" class="flex-1 p-8 overflow-y-auto hidden">
        <div id="lesson-content">
            <!-- Competence Mode -->
            <div id="competence-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Competence Mode</h3>

                <!-- Individual Leaderboard -->
                <div id="individual-leaderboard" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Individual Leaderboard</h3>
                    <ul id="individual-leaderboard-list" class="space-y-2"></ul>
                </div>

                <!-- Award Points and Badges to Students (Visible to Teachers Only) -->
                <div id="points-award" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Points to Students</h3>
                        <select id="student-list" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <div class="point-buttons grid grid-cols-2 gap-4">
                            <button onclick="adjustPoints(10)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+10xp</button>
                            <button onclick="adjustPoints(20)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+20xp</button>
                            <button onclick="adjustPoints(50)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+50xp</button>
                            <button onclick="adjustPoints(100)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+100xp</button>
                            <button onclick="adjustPoints(-10)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-10xp</button>
                            <button onclick="adjustPoints(-20)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-20xp</button>
                            <button onclick="adjustPoints(-50)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-50xp</button>
                            <button onclick="adjustPoints(-100)" class="neumorphic-button py-2 px-4 text-red-600 font-semibold">-100xp</button>
                        </div>
                    </div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Badges to Students</h3>
                        <div class="badge-buttons grid grid-cols-2 gap-4">
                            <button onclick="awardBadge('first to answer')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">First to Answer</button>
                            <button onclick="awardBadge('first to finish')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">First to Finish</button>
                            <button onclick="awardBadge('Hardworking')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Hardworking</button>
                            <button onclick="awardBadge('Team Player')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Team Player</button>
                            <button onclick="awardBadge('Creative Thinker')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Creative Thinker</button>
                            <button onclick="awardBadge('Problem Solver')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Problem Solver</button>
                            <button onclick="awardBadge('Critical Thinker')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Critical Thinker</button>
                            <button onclick="awardBadge('Persistent')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Persistent</button>
                            <button onclick="awardBadge('Quick Learner')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Quick Learner</button>
                            <button onclick="awardBadge('Leader')" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Leader</button>
                        </div>
                    </div>
                </div>

                <!-- Student Progress Bar (Visible to Students Only) -->
                <div id="student-progress" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Your Progress</h3>
                        <div class="mb-4">
                            <span id="current-level" class="text-indigo-600 font-semibold"></span>
                            <div class="progress-bar h-4 mt-2">
                                <div id="progress" class="progress h-full"></div>
                            </div>
                            <span id="next-level" class="text-indigo-600 font-semibold"></span>
                        </div>
                        <div class="badge-container">
                            <h4 class="text-lg font-semibold mb-2 text-indigo-600">Your Badges</h4>
                            <div id="earned-badges" class="flex flex-wrap gap-2"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Autonomy Mode -->
            <div id="autonomy-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Autonomy Mode</h3>
                <div id="avatar-customization" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Customize Your Avatar</h3>
                    <img id="avatar" src="default-avatar.png" alt="Avatar" class="w-32 h-32 rounded-full mx-auto mb-4" />
                    <input type="text" id="avatar-url" placeholder="Enter Avatar Image URL" class="neumorphic-inset w-full p-2 mb-4" />
                    <button onclick="updateAvatar()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Update Avatar</button>
                </div>
            </div>

            <!-- Relatedness Mode -->
            <div id="relatedness-mode" class="hidden space-y-8">
                <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Relatedness Mode</h3>

                <!-- Team Leaderboard -->
                <div id="team-leaderboard" class="neumorphic p-6">
                    <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Leaderboard</h3>
                    <ul id="team-leaderboard-list" class="space-y-2"></ul>
                </div>

                <!-- Team Management (Visible to Teachers Only) -->
                <div id="team-management" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Management</h3>
                        <select id="student-group-list" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <input type="text" id="team-name" placeholder="Enter Team Name" class="neumorphic-inset w-full p-2 mb-4" />
                        <button onclick="assignTeam()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Assign to Team</button>
                    </div>
                    <div id="teams-list" class="neumorphic p-6"></div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Award Points to Teams</h3>
                        <select id="team-select" class="neumorphic-inset w-full p-2 mb-4"></select>
                        <div class="point-buttons grid grid-cols-2 gap-4">
                            <button onclick="awardTeamPoints(10)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+10xp</button>
                            <button onclick="awardTeamPoints(20)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+20xp</button>
                            <button onclick="awardTeamPoints(50)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+50xp</button>
                            <button onclick="awardTeamPoints(100)" class="neumorphic-button py-2 px-4 text-green-600 font-semibold">+100xp</button>
                        </div>
                    </div>
                </div>

                <!-- Student Team Information (Visible to Students Only) -->
                <div id="student-team-info" class="hidden space-y-6">
                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Your Team: <span id="student-team-name" class="text-indigo-800"></span></h3>
                        <ul id="student-team-members" class="list-disc list-inside space-y-2"></ul>
                    </div>

                    <div class="neumorphic p-6">
                        <h3 class="text-xl font-semibold mb-4 text-indigo-600">Team Messages</h3>
                        <div id="student-messages-list" class="space-y-4 mb-4"></div>
                        <input type="text" id="team-message-input" placeholder="Enter your message" class="neumorphic-inset w-full p-2 mb-4" />
                        <button onclick="sendMessage()" class="neumorphic-button w-full py-2 px-4 text-indigo-600 font-semibold">Send</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- New Lessons Section -->
        <div id="lessons-section" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Lessons</h3>
            <div id="lessons-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- New Lesson Management Section (Visible to Teachers Only) -->
        <div id="lesson-management" class="hidden space-y-8">
            <h3 class="text-2xl font-semibold text-center text-indigo-600 mb-6">Lesson Management</h3>
            <button onclick="showAddLessonForm()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Add New Lesson</button>
            <div id="add-lesson-form" class="hidden space-y-4">
                <input type="text" id="lesson-title" placeholder="Lesson Title (required)" class="neumorphic-inset w-full p-2" required>
                <input type="text" id="lesson-task" placeholder="Lesson Task (optional)" class="neumorphic-inset w-full p-2">
                <div id="lesson-editor" class="neumorphic-inset w-full p-2 h-32"></div>
                <input type="file" id="lesson-image" accept="image/*" class="neumorphic-inset w-full p-2">
                <div id="lesson-image-preview-container" class="hidden mt-2">
                    <img id="lesson-image-preview" class="max-w-full h-auto" alt="Image preview" />
                </div>
                <input type="file" id="lesson-pdf" accept=".pdf" class="neumorphic-inset w-full p-2">
                <span id="lesson-pdf-label" class="text-sm text-gray-600"></span>
                <input type="text" id="lesson-link" placeholder="External Link" class="neumorphic-inset w-full p-2">
                <button onclick="saveLesson()" class="neumorphic-button py-2 px-4 text-indigo-600 font-semibold">Save Lesson</button>
            </div>
            <div id="lessons-management-list" class="space-y-4"></div>
        </div>
    </div>
</div>

<div id="auth-container" class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50">
    <div class="neumorphic p-8 w-full max-w-md">
        <h2 id="auth-title" class="text-2xl font-bold mb-6 text-center text-indigo-600">Login</h2>
        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="password" id="login-password" placeholder="Password" required class="neumorphic-inset w-full p-3 mb-4" />
            <button onclick="login()" class="neumorphic-button w-full py-3 px-4 text-indigo-600 font-semibold mb-4">Login</button>
            <p class="text-center text-gray-600">Don't have an account? <a href="#" onclick="showRegister()" class="text-indigo-600 font-semibold">Register</a></p>
        </div>

        <div id="register-form" class="hidden">
            <input type="text" id="register-school-code" placeholder="School Code" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="text" id="register-fullname" placeholder="Full Name" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="email" id="register-email" placeholder="Email" required class="neumorphic-inset w-full p-3 mb-4" />
            <input type="password" id="register-password" placeholder="Password" required class="neumorphic-inset w-full p-3 mb-4" />
            <select id="register-role" class="neumorphic-inset w-full p-3 mb-4">
                <option value="student">Student</option>
                <option value="teacher">Teacher</option>
            </select>
            <select id="register-gamification-mode" class="neumorphic-inset w-full p-3 mb-4 hidden">
                <option value="competence">Competence</option>
                <option value="autonomy">Autonomy</option>
                <option value="relatedness">Relatedness</option>
            </select>
            <button onclick="register()" class="neumorphic-button w-full py-3 px-4 text-indigo-600 font-semibold mb-4">Register</button>
            <p class="text-center text-gray-600">Already have an account? <a href="#" onclick="showLogin()" class="text-indigo-600 font-semibold">Login</a></p>
        </div>
    </div>
</div>

<!-- Lesson Modal -->
<!-- Lesson Modal -->
<div id="lesson-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
    <div class="bg-white w-full h-full max-w-5xl mx-auto p-8 rounded-lg shadow-lg relative overflow-auto">
        <button onclick="closeLessonModal()" class="absolute top-4 right-4 text-gray-600 text-2xl font-bold">&times;</button>
        <h2 id="modal-lesson-title" class="text-2xl font-semibold mb-4 text-indigo-600"></h2>
        <div id="modal-lesson-task" class="text-lg mb-4"></div>
        <div id="modal-lesson-content" class="mb-4"></div>
        <div class="flex justify-center mb-4">
            <img id="modal-lesson-image" class="max-w-full h-auto rounded-lg" alt="Lesson Image" />
        </div>
        <a id="modal-lesson-pdf" href="#" target="_blank" class="block mb-2 text-blue-600 hover:underline">Download PDF</a>
        <a id="modal-lesson-link" href="#" target="_blank" class="block text-blue-600 hover:underline">Visit Link</a>
    </div>
</div>



<!-- Include Quill library -->
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>
<script type="module">
    // Firebase configuration and initialization
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-auth.js";
    import { getDatabase, ref, set, get, update, push, onValue } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-database.js";
    import { getStorage, ref as storageRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/9.1.0/firebase-storage.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCYMlv_m2BcTrhm60hLroWVs0W_9SHSVfQ",
        authDomain: "gamification-app-856a4.firebaseapp.com",
        databaseURL: "https://gamification-app-856a4-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "gamification-app-856a4",
        storageBucket: "gamification-app-856a4.appspot.com",
        messagingSenderId: "966888657590",
        appId: "1:966888657590:web:98f5990d1c933f8cbc0c17",
        measurementId: "G-QVK4E2GD51"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);
    const storage = getStorage(app);

    // Show login form
    window.showLogin = function () {
        document.getElementById('login-form').style.display = 'block';
        document.getElementById('register-form').style.display = 'none';
        document.getElementById('auth-title').textContent = 'Login';
    }

    // Show register form
    window.showRegister = function () {
        document.getElementById('login-form').style.display = 'none';
        document.getElementById('register-form').style.display = 'block';
        document.getElementById('auth-title').textContent = 'Register';
    }

    // Handle login
    window.login = async function () {
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;

        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            loadDashboard(userCredential.user);
        } catch (error) {
            alert('Login failed: ' + error.message);
        }
    }

    // Handle registration
    window.register = async function () {
        const schoolCode = document.getElementById('register-school-code').value;
        const fullName = document.getElementById('register-fullname').value;
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        const role = document.getElementById('register-role').value;
        const gamificationMode = document.getElementById('register-gamification-mode').value;

        try {
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            const user = userCredential.user;

            await set(ref(db, 'users/' + user.uid), {
                schoolCode: schoolCode,
                fullName: fullName,
                email: email,
                role: role,
                gamificationMode: gamificationMode
            });

            // If the user is a teacher, set the gamification mode for the school
            if (role === 'teacher') {
                await set(ref(db, 'schools/' + schoolCode), {
                    gamificationMode: gamificationMode
                });
            }

            loadDashboard(user);
        } catch (error) {
            alert('Registration failed: ' + error.message);
        }
    }

    // Load dashboard (for both teachers and students)
    async function loadDashboard(user) {
        try {
            const userRef = ref(db, 'users/' + user.uid);
            const userSnapshot = await get(userRef);
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();

                document.getElementById('auth-container').style.display = 'none';
                document.getElementById('sidebar').style.display = 'flex';
                document.getElementById('main-content').style.display = 'block';

                document.getElementById('user-name').textContent = userData.fullName;
                document.getElementById('user-role').textContent = userData.role;

                // Fetch the gamification mode for the user's school
                const schoolRef = ref(db, 'schools/' + userData.schoolCode);
                const schoolSnapshot = await get(schoolRef);

                if (schoolSnapshot.exists()) {
                    const schoolData = schoolSnapshot.val();
                    displayGamificationMode(schoolData.gamificationMode, userData.role, userData.schoolCode);

                    // Adjust sidebar content based on gamification mode and role
                    updateSidebarContent(userData.role, schoolData.gamificationMode);

                    if (userData.role === "teacher") {
                        if (schoolData.gamificationMode === 'competence') {
                            document.getElementById('points-award').style.display = 'block';
                            document.getElementById('student-progress').style.display = 'none'; // Hide student progress for teachers
                            loadStudents(userData.schoolCode, false);
                        } else if (schoolData.gamificationMode === 'relatedness') {
                            document.getElementById('team-management').style.display = 'block';
                            loadStudentsForGroupAssignment(userData.schoolCode);
                            loadTeams(userData.schoolCode);
                            setupTeamLeaderboardListener(userData.schoolCode);
                        }
                    } else if (userData.role === "student") {
                        if (schoolData.gamificationMode === 'competence') {
                            loadIndividualLeaderboard(userData.schoolCode);
                            loadStudentProgress(user.uid);
                        } else if (schoolData.gamificationMode === 'relatedness') {
                            loadStudentTeam(user.uid);
                            setupTeamLeaderboardListener(userData.schoolCode); // Set up real-time listener for the team leaderboard
                        }
                    }
                } else {
                    console.log("No school data found for this user.");
                }
            } else {
                alert('No data available');
            }
        } catch (error) {
            console.error('Failed to load dashboard:', error);
        }
    }

    // Update the sidebar content based on role and gamification mode
    function updateSidebarContent(role, mode) {
        const sidebarContent = document.getElementById('sidebar-content');
        sidebarContent.innerHTML = '';

        const commonItems = `
            <li class="text-gray-700 hover:text-indigo-600 cursor-pointer" onclick="showDashboard()">Dashboard</li>
            <li class="text-gray-700 hover:text-indigo-600 cursor-pointer" onclick="showLessons()">Lessons</li>
        `;

        if (mode === 'competence') {
            sidebarContent.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-indigo-600">Competence Mode</h3>
                <ul class="space-y-2">
                    ${commonItems}
                    
                    
                    
                    
                </ul>
            `;
        } else if (mode === 'autonomy') {
            sidebarContent.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-indigo-600">Autonomy Mode</h3>
                <ul class="space-y-2">
                    ${commonItems}
                    
                </ul>
            `;
        } else if (mode === 'relatedness') {
            sidebarContent.innerHTML = `
                <h3 class="text-lg font-semibold mb-2 text-indigo-600">Relatedness Mode</h3>
                <ul class="space-y-2">
                    ${commonItems}
                    
                    
                    
                </ul>
            `;
        }

        if (role === 'teacher') {
            sidebarContent.innerHTML += `
                <div class="mt-6">
                    <h4 class="text-lg font-semibold mb-2 text-indigo-600">Teacher Actions</h4>
                    <ul class="space-y-2">
                        <li class="text-gray-700 hover:text-indigo-600 cursor-pointer" onclick="showLessonManagement()">Manage Lessons</li>
                        ${mode === 'competence' ? `
                            
                            
                        ` : ''}
                        ${mode === 'relatedness' ? `
                            
                            
                        ` : ''}
                    </ul>
                </div>
            `;
        }
    }

    // Display gamification mode
    function displayGamificationMode(mode, role, schoolCode) {
        document.getElementById('gamification-text').textContent = mode.charAt(0).toUpperCase() + mode.slice(1);

        document.getElementById('competence-mode').style.display = mode === 'competence' ? 'block' : 'none';
        document.getElementById('autonomy-mode').style.display = mode === 'autonomy' ? 'block' : 'none';
        document.getElementById('relatedness-mode').style.display = mode === 'relatedness' ? 'block' : 'none';

        if (role === 'student') {
            // Hide the ability to award points and assign teams from students
            document.getElementById('points-award').style.display = 'none';
            document.getElementById('team-management').style.display = 'none';

            if (mode === 'competence') {
                loadIndividualLeaderboard(schoolCode);
            } else if (mode === 'relatedness') {
                setupTeamLeaderboardListener(schoolCode);
            }
        }
    }

    // Load individual leaderboard for students in competence mode
    // Load individual leaderboard for students in competence mode in real-time
async function loadIndividualLeaderboard(schoolCode) {
    try {
        const leaderboardRef = ref(db, `schools/${schoolCode}/leaderboard`);
        
        // Listen for changes to the leaderboard data
        onValue(leaderboardRef, (snapshot) => {
            const leaderboardList = document.getElementById('individual-leaderboard-list');
            leaderboardList.innerHTML = '';

            // Create an array to store students for sorting
            let students = [];

            snapshot.forEach((childSnapshot) => {
                const student = childSnapshot.val();
                students.push({ name: student.name, points: student.points });
            });

            // Sort the students by points in descending order
            students.sort((a, b) => b.points - a.points);

            // Render the sorted students in the leaderboard
            students.forEach((student) => {
                const li = document.createElement('li');
                li.textContent = `${student.name} - ${student.points} points`;
                li.className = 'py-2 border-b border-gray-200 last:border-b-0';
                leaderboardList.appendChild(li);
            });
        }, (error) => {
            console.error('Failed to load individual leaderboard in real-time:', error);
        });
    } catch (error) {
        console.error('Failed to load individual leaderboard:', error);
    }
}


    // Load team leaderboard for relatedness mode in real-time
function setupTeamLeaderboardListener(schoolCode) {
    const teamsRef = ref(db, `schools/${schoolCode}/teams`);
    
    // Listen for changes to the teams data
    onValue(teamsRef, (snapshot) => {
        const leaderboardList = document.getElementById('team-leaderboard-list');
        leaderboardList.innerHTML = ''; // Clear the list first

        // Create an array to store teams for sorting
        let teams = [];

        snapshot.forEach((childSnapshot) => {
            const team = childSnapshot.val();
            teams.push({ name: childSnapshot.key, points: team.points || 0 });
        });

        // Sort the teams by points in descending order
        teams.sort((a, b) => b.points - a.points);

        // Render the sorted teams in the leaderboard
        teams.forEach((team) => {
            const li = document.createElement('li');
            li.textContent = `${team.name} - ${team.points} points`;
            li.className = 'py-2 border-b border-gray-200 last:border-b-0';
            leaderboardList.appendChild(li);
        });
    }, (error) => {
        console.error('Failed to load team leaderboard in real-time:', error);
    });
}


    // Load student progress for competence mode in real-time
async function loadStudentProgress(uid) {
    try {
        const studentRef = ref(db, `users/${uid}`);
        
        // Listen for changes to the student's points
        onValue(studentRef, (snapshot) => {
            if (snapshot.exists()) {
                const studentData = snapshot.val();
                const currentPoints = studentData.points || 0;
                const currentLevel = Math.floor(currentPoints / 1000) + 1;
                const nextLevel = currentLevel + 1;
                const progress = (currentPoints % 1000) / 10;

                document.getElementById('current-level').textContent = `Level: ${currentLevel}`;
                document.getElementById('progress').style.width = `${progress}%`;
                document.getElementById('next-level').textContent = `Next Level: ${nextLevel}`;

                // Update badges in real-time
                loadEarnedBadges(uid);
                document.getElementById('student-progress').style.display = 'block';
            }
        }, (error) => {
            console.error('Failed to load student progress in real-time:', error);
        });
    } catch (error) {
        console.error('Failed to load student progress:', error);
    }
}

// Load earned badges for a student in real-time
async function loadEarnedBadges(uid) {
    try {
        const badgesRef = ref(db, `users/${uid}/badges`);
        
        // Listen for changes to the student's badges
        onValue(badgesRef, (snapshot) => {
            const badgesContainer = document.getElementById('earned-badges');
            badgesContainer.innerHTML = '';

            // Create badge elements only for earned badges
            snapshot.forEach((childSnapshot) => {
                const badgeName = childSnapshot.val();
                const badge = document.createElement('div');
                badge.className = 'neumorphic p-2 rounded-full';
                const img = document.createElement('img');
                img.src = `images/badges/${badgeName.toLowerCase().replace(/ /g, '-')}.png`;
                img.alt = badgeName;
                img.className = 'w-12 h-12';

                // Set default image if badge image fails to load
                img.onerror = () => {
                    img.src = 'images/badges/default-badge.png';
                };

                badge.appendChild(img);
                badge.title = badgeName; // Add tooltip with badge name
                badgesContainer.appendChild(badge);
            });

            // If no badges earned, display a message
            if (badgesContainer.children.length === 0) {
                const noBadgesMsg = document.createElement('p');
                noBadgesMsg.textContent = 'No badges earned yet.';
                noBadgesMsg.className = 'text-gray-500 italic';
                badgesContainer.appendChild(noBadgesMsg);
            }
        }, (error) => {
            console.error('Failed to load earned badges in real-time:', error);
        });
    } catch (error) {
        console.error('Failed to load earned badges:', error);
    }
}


    // Load students list for the teacher
    async function loadStudents(schoolCode, showAvatars = false) {
        try {
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);
            const studentList = document.getElementById('student-list');
            studentList.innerHTML = ''; // Clear the list first

            let studentsFound = false;

            snapshot.forEach((childSnapshot) => {
                const userData = childSnapshot.val();
                if (userData.schoolCode === schoolCode && userData.role === 'student') {
                    const option = document.createElement('option');
                    option.value = childSnapshot.key; // Use student's UID as value
                    option.textContent = userData.fullName; // Show student's full name in the dropdown
                    studentList.appendChild(option);
                    studentsFound = true;
                }
            });

            if (!studentsFound) {
                const option = document.createElement('option');
                option.textContent = 'No students found';
                option.disabled = true;
                studentList.appendChild(option);
            }
        } catch (error) {
            console.error('Failed to load students list:', error);
        }
    }

    // Adjust points for a student (Only for teachers)
    window.adjustPoints = async function (points) {
        const studentUid = document.getElementById('student-list').value;

        if (studentUid) {
            try {
                const studentRef = ref(db, `users/${studentUid}`);
                const studentSnapshot = await get(studentRef);

                if (studentSnapshot.exists()) {
                    const studentData = studentSnapshot.val();
                    const newPoints = (studentData.points || 0) + points;

                    // Update points for the student
                    await update(studentRef, { points: newPoints });

                    // Update leaderboard
                    const leaderboardRef = ref(db, `schools/${studentData.schoolCode}/leaderboard/${studentUid}`);
                    await set(leaderboardRef, { name: studentData.fullName, points: newPoints });

                    alert('Points adjusted successfully!');
                    loadIndividualLeaderboard(studentData.schoolCode); // Reload leaderboard to reflect changes
                }
            } catch (error) {
                console.error('Failed to adjust points:', error);
            }
        }
    }

    // Award badges to a student (Only for teachers)
    window.awardBadge = async function (badgeName) {
        const studentUid = document.getElementById('student-list').value;

        if (studentUid) {
            try {
                const badgesRef = ref(db, `users/${studentUid}/badges`);
                const badgeSnapshot = await get(badgesRef);

                let badges = badgeSnapshot.exists() ? badgeSnapshot.val() : [];
                if (!badges.includes(badgeName)) {
                    badges.push(badgeName);
                    await set(badgesRef, badges);

                    alert('Badge awarded successfully!');
                } else {
                    alert('Student already has this badge.');
                }
            } catch (error) {
                console.error('Failed to award badge:', error);
            }
        }
    }

    // Update avatar
    window.updateAvatar = async function () {
        const avatarUrl = document.getElementById('avatar-url').value;
        const user = auth.currentUser;

        if (user) {
            try {
                await update(ref(db, 'users/' + user.uid), { avatarUrl: avatarUrl });
                document.getElementById('avatar').src = avatarUrl;
                alert('Avatar updated successfully!');
            } catch (error) {
                alert('Failed to update avatar: ' + error.message);
            }
        }
    }

    // Load students for group assignment (For teachers)
    async function loadStudentsForGroupAssignment(schoolCode) {
        try {
            const usersRef = ref(db, 'users');
            const snapshot = await get(usersRef);
            const studentGroupList = document.getElementById('student-group-list');
            studentGroupList.innerHTML = ''; // Clear the list first

            snapshot.forEach((childSnapshot) => {
                const userData = childSnapshot.val();
                if (userData.schoolCode === schoolCode && userData.role === 'student') {
                    const option = document.createElement('option');
                    option.value = childSnapshot.key; // Use student's UID as value
                    option.textContent = userData.fullName; // Show student's full name in the dropdown
                    studentGroupList.appendChild(option);
                }
            });

            if (studentGroupList.options.length === 0) {
                const option = document.createElement('option');
                option.textContent = 'No students found';
                option.disabled = true;
                studentGroupList.appendChild(option);
            }
        } catch (error) {
            console.error('Failed to load students for group assignment:', error);
        }
    }

    // Assign a student to a team
    window.assignTeam = async function () {
        const studentUid = document.getElementById('student-group-list').value;
        const teamName = document.getElementById('team-name').value;
        const schoolCode = (await get(ref(db, 'users/' + studentUid))).val().schoolCode;

        if (studentUid && teamName) {
            try {
                await update(ref(db, 'users/' + studentUid), { teamName: teamName });

                // Update the team in the school's data
                const teamRef = ref(db, `schools/${schoolCode}/teams/${teamName}/members`);
                const teamSnapshot = await get(teamRef);
                const members = teamSnapshot.exists() ? teamSnapshot.val() : [];
                members.push(studentUid);

                await set(ref(db, `schools/${schoolCode}/teams/${teamName}`), { members: members });
                alert('Student assigned to team: ' + teamName);
                loadTeams(schoolCode);
            } catch (error) {
                alert('Failed to assign team: ' + error.message);
            }
        }
    }

    // Load teams and display them (For teachers)
    async function loadTeams(schoolCode) {
        try {
            const teamsRef = ref(db, `schools/${schoolCode}/teams`);
            const snapshot = await get(teamsRef);
            const teamsList = document.getElementById('teams-list');
            const teamSelect = document.getElementById('team-select');
            teamsList.innerHTML = ''; // Clear the list first
            teamSelect.innerHTML = ''; // Clear the list first

            snapshot.forEach((childSnapshot) => {
                const teamData = childSnapshot.val();
                const teamContainer = document.createElement('div');
                teamContainer.className = 'neumorphic p-4 mb-4';
                const h4 = document.createElement('h4');
                h4.textContent = `Team: ${childSnapshot.key}`;
                h4.className = 'text-lg font-semibold mb-2 text-indigo-600';
                teamContainer.appendChild(h4);

                const membersList = document.createElement('ul');
                membersList.className = 'space-y-1';

                teamData.members.forEach((memberUid) => {
                    const memberRef = ref(db, `users/${memberUid}`);
                    get(memberRef).then((memberSnapshot) => {
                        const memberData = memberSnapshot.val();
                        const li = document.createElement('li');
                        li.textContent = memberData.fullName;
                        li.className = 'text-gray-700';
                        membersList.appendChild(li);
                    });
                });

                teamContainer.appendChild(membersList);
                teamsList.appendChild(teamContainer);

                const option = document.createElement('option');
                option.value = childSnapshot.key;
                option.textContent = `Team: ${childSnapshot.key}`;
                teamSelect.appendChild(option);
            });

            if (teamsList.children.length === 0) {
                const noTeamsMessage = document.createElement('p');
                noTeamsMessage.textContent = 'No teams found';
                noTeamsMessage.className = 'text-gray-500 italic';
                teamsList.appendChild(noTeamsMessage);
            }

        } catch (error) {
            console.error('Failed to load teams:', error);
        }
    }

    // Load the team of the logged-in student and display it (For students)
    async function loadStudentTeam(uid) {
        try {
            const userRef = ref(db, 'users/' + uid);
            const userSnapshot = await get(userRef);
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                const teamName = userData.teamName;
                const schoolCode = userData.schoolCode;

                if (teamName) {
                    const teamsRef = ref(db, `schools/${schoolCode}/teams/${teamName}`);
                    const teamSnapshot = await get(teamsRef);

                    if (teamSnapshot.exists()) {
                        const teamData = teamSnapshot.val();
                        const teamList = document.getElementById('student-team-members');
                        teamList.innerHTML = ''; // Clear the list first

                        const teamNameElement = document.getElementById('student-team-name');
                        teamNameElement.textContent = teamName;

                        teamData.members.forEach((memberId) => {
                            const memberRef = ref(db, `users/${memberId}`);
                            get(memberRef).then((memberSnapshot) => {
                                const memberData = memberSnapshot.val();
                                const li = document.createElement('li');
                                li.textContent = memberData.fullName;
                                li.className = 'text-gray-700';
                                teamList.appendChild(li);
                            });
                        });

                        // Load team messages
                        loadTeamMessages(schoolCode, teamName);

                        // Display the student team info section
                        document.getElementById('student-team-info').style.display = 'block';
                    }
                }
            }
        } catch (error) {
            console.error('Failed to load student team:', error);
        }
    }

   // Load team messages and set up real-time listeners
async function loadTeamMessages(schoolCode, teamName) {
    try {
        const messagesRef = ref(db, `schools/${schoolCode}/teams/${teamName}/messages`);
        const messagesList = document.getElementById('student-messages-list');
        messagesList.innerHTML = ''; // Clear the list first

        // Listen for new messages in real-time
        onValue(messagesRef, (snapshot) => {
            messagesList.innerHTML = ''; // Clear the list before appending new messages

            snapshot.forEach((childSnapshot) => {
                const messageData = childSnapshot.val();
                const messageId = childSnapshot.key;
                const messageContainer = document.createElement('div');
                messageContainer.className = 'message-container p-4 rounded-lg shadow-md mb-4 bg-white';

                const messageHeader = document.createElement('div');
                messageHeader.className = 'message-header font-semibold text-indigo-600 mb-1';

                const messageText = document.createElement('div');
                messageText.className = 'message-text mb-2';
                messageText.textContent = messageData.text;

                const messageSender = document.createElement('div');
                messageSender.className = 'message-sender text-sm text-gray-600';
                messageSender.textContent = `Sent by: ${messageData.sender}`;

                const messageTimestamp = document.createElement('div');
                messageTimestamp.textContent = new Date(messageData.timestamp).toLocaleString();
                messageTimestamp.className = 'text-xs text-gray-500';

                const messageActions = document.createElement('div');
                messageActions.className = 'message-actions flex space-x-2 mt-2';

                const currentLikes = Array.isArray(messageData.likes) ? messageData.likes : [];
                const currentDislikes = Array.isArray(messageData.dislikes) ? messageData.dislikes : [];

                const likeButton = document.createElement('button');
                likeButton.textContent = ` Like (${currentLikes.length})`;
                likeButton.className = 'neumorphic-button text-sm py-1 px-2 text-blue-600';
                likeButton.onclick = () => toggleLikeDislike(schoolCode, teamName, messageId, currentLikes, currentDislikes, true);

                const dislikeButton = document.createElement('button');
                dislikeButton.textContent = ` Dislike (${currentDislikes.length})`;
                dislikeButton.className = 'neumorphic-button text-sm py-1 px-2 text-red-600';
                dislikeButton.onclick = () => toggleLikeDislike(schoolCode, teamName, messageId, currentLikes, currentDislikes, false);

                messageActions.appendChild(likeButton);
                messageActions.appendChild(dislikeButton);

                messageHeader.appendChild(messageSender);
                messageHeader.appendChild(messageTimestamp);

                messageContainer.appendChild(messageHeader);
                messageContainer.appendChild(messageText);
                messageContainer.appendChild(messageActions);

                if (currentLikes.length > 0) {
                    const likesList = document.createElement('div');
                    likesList.className = 'message-likes-dislikes text-sm text-blue-600';
                    likesList.textContent = `${currentLikes.join(", ")} liked this`;
                    messageContainer.appendChild(likesList);
                }

                if (currentDislikes.length > 0) {
                    const dislikesList = document.createElement('div');
                    dislikesList.className = 'message-likes-dislikes text-sm text-red-600';
                    dislikesList.textContent = `${currentDislikes.join(", ")} disliked this`;
                    messageContainer.appendChild(dislikesList);
                }

                messagesList.appendChild(messageContainer);
            });

            // Scroll to the latest message
            messagesList.scrollTop = messagesList.scrollHeight;
        }, (error) => {
            console.error('Failed to load team messages in real-time:', error);
        });
    } catch (error) {
        console.error('Failed to load team messages:', error);
    }
}

// Toggle like or dislike on a message
async function toggleLikeDislike(schoolCode, teamName, messageId, currentLikes, currentDislikes, isLike) {
    const user = auth.currentUser;
    const userRef = await get(ref(db, 'users/' + user.uid));
    const userData = userRef.val();

    const messageRef = ref(db, `schools/${schoolCode}/teams/${teamName}/messages/${messageId}`);

    if (isLike) {
        if (currentLikes.includes(userData.fullName)) {
            alert('You have already liked this message.');
        } else {
            // Remove dislike if present
            if (currentDislikes.includes(userData.fullName)) {
                const dislikeIndex = currentDislikes.indexOf(userData.fullName);
                currentDislikes.splice(dislikeIndex, 1);
            }
            currentLikes.push(userData.fullName);
            await update(messageRef, { likes: currentLikes, dislikes: currentDislikes });
            alert('You liked this message.');
        }
    } else {
        if (currentDislikes.includes(userData.fullName)) {
            alert('You have already disliked this message.');
        } else {
            // Remove like if present
            if (currentLikes.includes(userData.fullName)) {
                const likeIndex = currentLikes.indexOf(userData.fullName);
                currentLikes.splice(likeIndex, 1);
            }
            currentDislikes.push(userData.fullName);
            await update(messageRef, { likes: currentLikes, dislikes: currentDislikes });
            alert('You disliked this message.');
        }
    }
}


    // Send a new message to the team
    window.sendMessage = async function () {
        const messageInput = document.getElementById('team-message-input');
        const messageText = messageInput.value.trim();
        const user = auth.currentUser;

        if (messageText !== '') {
            try {
                const userRef = await get(ref(db, 'users/' + user.uid));
                const userData = userRef.val();
                const teamName = userData.teamName;
                const schoolCode = userData.schoolCode;

                const messagesRef = ref(db, `schools/${schoolCode}/teams/${teamName}/messages`);
                await push(messagesRef, {
                    text: messageText,
                    sender: userData.fullName,
                    timestamp: Date.now()
                });

                messageInput.value = ''; // Clear the input after sending the message
            } catch (error) {
                alert('Failed to send message: ' + error.message);
            }
        }
    }

    // Award points to a team (For teachers)
window.awardTeamPoints = async function (points) {
    const teamName = document.getElementById('team-select').value;
    const user = auth.currentUser;

    if (teamName) {
        try {
            // Get the school code for the current user (teacher)
            const userRef = ref(db, 'users/' + user.uid);
            const userSnapshot = await get(userRef);
            const userData = userSnapshot.val();
            const schoolCode = userData.schoolCode;

            // Reference to the selected team in the database
            const teamRef = ref(db, `schools/${schoolCode}/teams/${teamName}`);
            const teamSnapshot = await get(teamRef);

            if (teamSnapshot.exists()) {
                const teamData = teamSnapshot.val();
                const newPoints = (teamData.points || 0) + points;

                // Update the points for the team
                await update(teamRef, { points: newPoints });

                alert(`Awarded ${points} points to the team: ${teamName}`);
                loadTeams(schoolCode); // Reload teams to reflect changes
            } else {
                alert('Selected team does not exist.');
            }
        } catch (error) {
            console.error('Failed to award points to the team:', error);
        }
    } else {
        alert('Please select a team.');
    }
}

    // Show dashboard view
    window.showDashboard = function () {
        document.getElementById('lesson-content').style.display = 'block';
        document.getElementById('lessons-section').style.display = 'none';
        document.getElementById('lesson-management').style.display = 'none';
    }

    // Show lessons view
   // Show lessons view
// Show lessons view
window.showLessons = async function () {
    const lessonsList = document.getElementById('lessons-list');
    lessonsList.innerHTML = ''; // Clear the list before adding new lessons

    const lessonsRef = ref(db, 'lessons');
    const lessonsSnapshot = await get(lessonsRef);

    lessonsSnapshot.forEach((childSnapshot) => {
        const lessonData = childSnapshot.val();
        const lessonCard = document.createElement('div');
        lessonCard.className = 'lesson-card neumorphic p-4';
        const lessonCardHeader = document.createElement('div');
        lessonCardHeader.className = 'lesson-card-header flex items-center justify-between';
        lessonCardHeader.textContent = lessonData.title;
        lessonCardHeader.onclick = function () {
            openLessonModal(lessonData); // Open modal with lesson content
        };
        const lessonCardContent = document.createElement('div');
        lessonCardContent.className = 'lesson-card-content';
        const lessonCardBody = document.createElement('div');
        lessonCardBody.className = 'lesson-card-body';

        const lessonTask = document.createElement('p');
        lessonTask.textContent = lessonData.task || 'No task assigned';
        lessonTask.style.marginBottom = '10px'; // Add space between task and content

        const lessonContent = document.createElement('div');
        lessonContent.innerHTML = lessonData.content; // Display the rich text content
        lessonContent.style.marginBottom = '20px'; // Add space after content

        lessonCardBody.appendChild(lessonTask);
        lessonCardBody.appendChild(lessonContent);
        lessonCardContent.appendChild(lessonCardBody);

        const lessonCardImage = document.createElement('img');
        lessonCardImage.className = 'lesson-card-image';
        lessonCardImage.src = lessonData.image || 'default-image.jpg';
        
        const lessonCardPDFLink = document.createElement('a');
        lessonCardPDFLink.href = lessonData.pdf || '#';
        lessonCardPDFLink.textContent = 'Download PDF';
        lessonCardPDFLink.target = '_blank'; // Open in a new tab

        const lessonCardExternalLink = document.createElement('a');
        lessonCardExternalLink.href = lessonData.externalLink || '#';
        lessonCardExternalLink.textContent = 'Visit Link';
        lessonCardExternalLink.target = '_blank'; // Open in a new tab

        lessonCardContent.appendChild(lessonCardImage);
        lessonCardContent.appendChild(document.createElement('br')); // Line break between PDF and external link
        lessonCardContent.appendChild(lessonCardPDFLink);
        lessonCardContent.appendChild(document.createElement('br')); // Separate PDF and Link
        lessonCardContent.appendChild(lessonCardExternalLink);

        lessonCard.appendChild(lessonCardHeader);
        lessonCard.appendChild(lessonCardContent);
        lessonsList.appendChild(lessonCard);
    });

    document.getElementById('lesson-content').style.display = 'none';
    document.getElementById('lessons-section').style.display = 'block';
    document.getElementById('lesson-management').style.display = 'none';
}

// Function to open the lesson in a modal
function openLessonModal(lessonData) {
    const modal = document.getElementById('lesson-modal');
    document.getElementById('modal-lesson-title').textContent = lessonData.title;
    document.getElementById('modal-lesson-task').textContent = lessonData.task;
    document.getElementById('modal-lesson-content').innerHTML = lessonData.content;
    document.getElementById('modal-lesson-image').src = lessonData.image || 'default-image.jpg';
    document.getElementById('modal-lesson-pdf').href = lessonData.pdf || '#';
    document.getElementById('modal-lesson-link').href = lessonData.externalLink || '#';

    modal.classList.remove('hidden');
}

// Function to close the modal
window.closeLessonModal = function () {
    const modal = document.getElementById('lesson-modal');
    modal.classList.add('hidden');
}

    // Show lesson management view (for teachers)
    window.showLessonManagement = async function () {
        const lessonsManagementList = document.getElementById('lessons-management-list');
        lessonsManagementList.innerHTML = ''; // Clear the list before adding new lessons

        const lessonsRef = ref(db, 'lessons');
        const lessonsSnapshot = await get(lessonsRef);

        lessonsSnapshot.forEach((childSnapshot) => {
            const lessonData = childSnapshot.val();
            const lessonCard = document.createElement('div');
            lessonCard.className = 'lesson-card neumorphic p-4';
            const lessonCardHeader = document.createElement('div');
            lessonCardHeader.className = 'lesson-card-header flex items-center justify-between';
            lessonCardHeader.textContent = lessonData.title;
            const editButton = document.createElement('button');
            editButton.textContent = 'Edit';
            editButton.className = 'neumorphic-button py-1 px-2 text-indigo-600 font-semibold ml-2';
            const deleteButton = document.createElement('button');
            deleteButton.textContent = 'Delete';
            deleteButton.className = 'neumorphic-button py-1 px-2 text-red-600 font-semibold ml-2';
            deleteButton.onclick = function () {
                deleteLesson(childSnapshot.key);
            };
            lessonCardHeader.appendChild(editButton);
            lessonCardHeader.appendChild(deleteButton);
            const lessonCardContent = document.createElement('div');
            lessonCardContent.className = 'lesson-card-content';
            const lessonCardBody = document.createElement('div');
            lessonCardBody.className = 'lesson-card-body';
            const lessonTask = document.createElement('p');
            lessonTask.textContent = lessonData.task || 'No task assigned';
            const lessonContent = document.createElement('div');
            lessonContent.innerHTML = lessonData.content; // Display the rich text content
            lessonCardBody.appendChild(lessonTask);
            lessonCardBody.appendChild(lessonContent);
            lessonCardContent.appendChild(lessonCardBody);
            const lessonCardImage = document.createElement('img');
            lessonCardImage.className = 'lesson-card-image';
            lessonCardImage.src = lessonData.image || 'default-image.jpg';
            const lessonCardPDFLink = document.createElement('a');
            lessonCardPDFLink.href = lessonData.pdf || '#';
            lessonCardPDFLink.textContent = 'Download PDF';
            const lessonCardExternalLink = document.createElement('a');
            lessonCardExternalLink.href = lessonData.externalLink || '#';
            lessonCardExternalLink.textContent = 'Visit Link';
            lessonCardContent.appendChild(lessonCardImage);
            lessonCardContent.appendChild(lessonCardPDFLink);
            lessonCardContent.appendChild(lessonCardExternalLink);
            lessonCard.appendChild(lessonCardHeader);
            lessonCard.appendChild(lessonCardContent);
            lessonsManagementList.appendChild(lessonCard);
        });

        document.getElementById('lesson-content').style.display = 'none';
        document.getElementById('lessons-section').style.display = 'none';
        document.getElementById('lesson-management').style.display = 'block';
    }

    // Show the add lesson form
    window.showAddLessonForm = function () {
        document.getElementById('add-lesson-form').classList.toggle('hidden');
    }

    // Save a new lesson
    window.saveLesson = async function () {
        const title = document.getElementById('lesson-title').value.trim();
        const task = document.getElementById('lesson-task').value.trim();
        const content = quill.root.innerHTML;
        const imageFile = document.getElementById('lesson-image').files[0];
        const pdfFile = document.getElementById('lesson-pdf').files[0];
        const externalLink = document.getElementById('lesson-link').value.trim();

        if (!title) {
            alert('Please provide a lesson title.');
            return;
        }

        try {
            const lessonRef = push(ref(db, 'lessons'));

            let imageUrl = '';
            if (imageFile) {
                const imageStorageRef = storageRef(storage, `lesson-images/${lessonRef.key}/${imageFile.name}`);
                const imageSnapshot = await uploadBytes(imageStorageRef, imageFile);
                imageUrl = await getDownloadURL(imageSnapshot.ref);
            }

            let pdfUrl = '';
            if (pdfFile) {
                const pdfStorageRef = storageRef(storage, `lesson-pdfs/${lessonRef.key}/${pdfFile.name}`);
                const pdfSnapshot = await uploadBytes(pdfStorageRef, pdfFile);
                pdfUrl = await getDownloadURL(pdfSnapshot.ref);
            }

            await set(lessonRef, {
                title: title,
                task: task,
                content: content,
                image: imageUrl,
                pdf: pdfUrl,
                externalLink: externalLink
            });

            alert('Lesson saved successfully!');
            showLessonManagement(); // Refresh the lessons list
        } catch (error) {
            alert('Failed to save lesson: ' + error.message);
        }
    }

    // Delete a lesson
    async function deleteLesson(lessonId) {
        const confirmDelete = confirm('Are you sure you want to delete this lesson?');

        if (confirmDelete) {
            try {
                await set(ref(db, 'lessons/' + lessonId), null);
                alert('Lesson deleted successfully!');
                showLessonManagement(); // Refresh the lessons list
            } catch (error) {
                alert('Failed to delete lesson: ' + error.message);
            }
        }
    }

    // Logout
    window.logout = function () {
        signOut(auth).then(() => {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('sidebar').style.display = 'none';
            document.getElementById('main-content').style.display = 'none';
        }).catch((error) => {
            console.error('Failed to logout:', error);
        });
    }

    // Quill Editor initialization
    const quill = new Quill('#lesson-editor', {
        theme: 'snow',
        placeholder: 'Enter the lesson content...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, 4, 5, 6, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link', 'image', 'video'],
                ['clean']
            ]
        }
    });

    // Lesson image preview
    document.getElementById('lesson-image').addEventListener('change', function (event) {
        const file = event.target.files[0];
        const previewContainer = document.getElementById('lesson-image-preview-container');
        const previewImage = document.getElementById('lesson-image-preview');

        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                previewImage.src = e.target.result;
                previewContainer.style.display = 'block';
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.style.display = 'none';
            previewImage.src = '';
        }
    });

    // Lesson PDF label
    document.getElementById('lesson-pdf').addEventListener('change', function (event) {
        const file = event.target.files[0];
        const label = document.getElementById('lesson-pdf-label');
        if (file) {
            label.textContent = file.name;
        } else {
            label.textContent = '';
        }
    });

    // Load avatar
    window.onload = async function () {
        const user = auth.currentUser;

        if (user) {
            const userSnapshot = await get(ref(db, 'users/' + user.uid));
            if (userSnapshot.exists()) {
                const userData = userSnapshot.val();
                if (userData.avatarUrl) {
                    document.getElementById('avatar').src = userData.avatarUrl;
                }
            }
        }
    }
</script>

</body>
</html>
